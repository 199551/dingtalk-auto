名称：智能巡检提醒
在：
  时间表：
    - cron： '*/10 16-23 * * *' # UTC 16-23点每10分钟 （北京时间0-7点）
    - cron： '*/10 0-15 * * *' # UTC 0-15点每10分钟 （北京时间8-23点）
  workflow_dispatch：
    输入：
      test_time：
        描述： '测试时间 （HH：MM）'
        必需：false
        默认值：''

职位：
  发送提醒：
    运行：ubuntu-latest
    步骤：
      - 名称：智能巡检提醒
        环境：
          DINGTALK_TOKEN：cfe74c285e2e30b46133eef62def804d28baef0d681a81ee0fdd1958fb13c877
        运行： |
# 设置时区
export TZ='亚洲/上海'
          
# 处理手动输入的测试时间
if [ -n “${{ github.event.inputs.test_time }}” ];然后
TEST_TIME=“${{ github.event.inputs.test_time }}”
echo “使用测试时间： $TEST_TIME”
CURRENT_HOUR=$（回声 $TEST_TIME | cut -d： -f1）
CURRENT_MINUTE=$（echo $TEST_TIME | cut -d： -f2）
CURRENT_TIME=$TEST_时间
还
CURRENT_HOUR=$（日期 +%H）
CURRENT_MINUTE=$（日期 +%M）
CURRENT_TIME=$（日期 +%H：%M）
菲
          
CURRENT_DATE=$（日期 +%Y-%m-%d）
CURRENT_WEEK=$（日期 +%u）
echo “当前时间（北京时间）： $（date）”
echo “当前日期： $CURRENT_DATE”
echo “当前时分： $CURRENT_TIME”
          
# 修复：更精确的跨天日期调整
HOUR_NUM=$（（10#$CURRENT_小时））
ADJUSTED_DATE=“$CURRENT_日期”
          
# 只在真正跨天的时间段（00:00-02:59）调整日期
如果 [ $HOUR_NUM -lt 3 ];然后
# 00:00-02:59 属于前一天的甲班
ADJUSTED_DATE=$（日期 -d “昨天” +%Y-%m-%d）
echo “调整日期为前一天： $ADJUSTED_DATE （处理跨天甲班）”
还
# 03:00-23:59 使用当前日期
echo “使用当前日期： $ADJUSTED_DATE”
菲
          
# 四班三倒循环计算，使用调整后的日期
START_DATE=“2025-10-27” # 以2025-10-27为甲班开始
DAYS_DIFF=$（（ （$（date -d “$ADJUSTED_DATE” +%s） - $（date -d “$START_DATE” +%s）） / 86400 ））
CYCLE_POS=$（（DAYS_DIFF % 4））
          
echo “从起始日（$START_DATE）相差天数： $DAYS_DIFF”
echo “周期位置： $CYCLE_POS （0=甲班， 1=休班， 2=乙班， 3=丙班）”
          
# 判断今日班次
case $CYCLE_POS 中的
0)
TODAY_SHIFT=“甲班 20：00-03：00”
IS_WORKING=true
              ;;
1)
TODAY_SHIFT=“休班”
IS_WORKING=假
              ;;
2)
TODAY_SHIFT=“乙班 03：00-11：00”
IS_WORKING=true
              ;;
3)
TODAY_SHIFT=“丙班 11：00-20：00”
IS_WORKING=true
              ;;
ESAC
          
echo “今日班次： $TODAY_SHIFT”
          
# 定义提醒时间点配置
声明 -A REMINDER_TIMES=（
["00:00"]="🕛 注意：线上巡检按时进行"
["02:00"]="🕑 注意：线上巡检按时进行"
["04:00"]="🕓 注意：线上巡检按时进行"
["06:00"]="🕕 注意：线上巡检按时进行"
["08:00"]="🕗 注意：线上巡检按时进行"
["10:00"]="🕙 注意：线上巡检按时进行"
["12:00"]="🕛 注意：线上巡检按时进行"
["14:00"]="🕑 注意：线上巡检按时进行"
["16:00"]="🕓 注意：线上巡检按时进行"
["18:00"]="🕕 注意：线上巡检按时进行"
["20:30"]="🕣 注意：线上巡检按时进行"
["22:00"]="🕙 注意：线上巡检按时进行"
          )
          
# 检查是否在提醒时间点的前后10分钟内
SHOULD_REMIND=假
TARGET_TIME=“”
REMINDER_CONTENT=“”
TIME_DIRECTION=“”
MINUTES_AWAY=0
          
time_key对于 “${！REMINDER_TIMES[@]}“;做
target_hour=$（回声 $time_key | cut -d： -f1）
target_minute=$（echo $time_key | cut -d： -f2）
            
target_total_minutes=$（（10#$target_hour * 60 + 10#$target_minute））
current_total_minutes=$（（10#$CURRENT_HOUR * 60 + 10#$CURRENT_MINUTE））
time_diff=$（（current_total_minutes - target_total_minutes））
            
# 前后10分钟窗口
if [ $time_diff -ge -10 ] & [ $time_diff -le 10 ];然后
SHOULD_REMIND=真
TARGET_TIME=$time_key
REMINDER_CONTENT=“${REMINDER_TIMES[$time_key]}”
              
如果 [ $time_diff -lt 0 ];然后
TIME_DIRECTION=“前”
MINUTES_AWAY=$（（0 - $time_diff））
elif [ $time_diff -gt 0 ];然后
TIME_DIRECTION=“后”
MINUTES_AWAY=$time_差异
还
TIME_DIRECTION=“正好”
MINUTES_AWAY=0
菲
破
菲
做
          
# 修复：更精确的班次工作时间判断
IS_WORKING_TIME=假
          
if [ “$IS_WORKING” = true ];然后
case $CYCLE_POS 中的
0) # 甲班 20:00-03:00 (跨天班次)
如果 [ $HOUR_NUM -ge 20 ] ||[ $HOUR_NUM -lt 3 ];然后
IS_WORKING_TIME=真
echo “ ✅ 当前在甲班工作时间 （20：00-03：00）”
菲
                ;;
2) # 乙班 03:00-11:00
如果 [ $HOUR_NUM -ge， 3 ] &; &; [ $HOUR_NUM -lt 11 ];然后
IS_WORKING_TIME=真
echo “ ✅ 当前在乙班工作时间 （03：00-11：00）”
菲
                ;;
3) # 丙班 11:00-20:00
如果 [ $HOUR_NUM -ge 11 ] &; &; [ $HOUR_NUM -lt 20 ];然后
IS_WORKING_TIME=真
echo “ ✅ 当前在丙班工作时间 （11：00-20：00）”
菲
                ;;
ESAC
菲
          
如果 [ “$SHOULD_REMIND” = true ];然后
echo “ ⏰ 在提醒时间窗口内： $TARGET_TIME （$TIME_DIRECTION${MINUTES_AWAY}分钟）”
            
如果 [ “$IS_WORKING_TIME” = true ];然后
echo “ ✅ 当前在上班时间，发送提醒...”
              
# 添加星期信息
WEEK_DAYS=（“周一”、“周二”、“周三”、“周四”、“周五”、“周六”、“周日”）
WEEK_INDEX=$（（CURRENT_WEEK - 1））
WEEK_INFO=“${WEEK_DAYS[$WEEK_INDEX]}”
              
# 构建完整的提醒内容
if [ “$TIME_DIRECTION” = “前” ];然后
REMIND_TYPE=“ ⏰ 即将到达巡检时段”
elif [ “$TIME_DIRECTION” = “后” ];然后
REMIND_TYPE=“ ⏰ 已过巡检时段”
还
REMIND_TYPE=“ ⏰ 正好在巡检时段”
菲
              
FULL_CONTENT=“$REMINDER_CONTENT\n$REMIND_TYPE\n📅 $CURRENT_DATE $WEEK_INFO\n👨 💼 今日班次：$TODAY_SHIFT\n🎯 目标时间：$TARGET_TIME\n⏱️ 当前时间：$CURRENT_TIME”
              
# 发送钉钉提醒
curl -X POST -H “内容类型：application/json” \
-d “{
\“msgtype\”： \“文本\”，
\“文本\”： {
\“内容\”： \“$FULL_内容\”
                  }
                }" \
“https://oapi.dingtalk.com/robot/send?access_token=$DINGTALK_TOKEN”
              
echo “ ✅ 提醒已发送”
还
echo “ ❌ 在提醒时间窗口内，但当前不在上班时间，跳过提醒”
菲
还
echo “ ⏳ 不在任何提醒时间窗口内”
菲
