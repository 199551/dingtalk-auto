name: æ¯æ—¥ä¸€å­¦æé†’
on:
  schedule:
    # å¢åŠ æ‰§è¡Œé¢‘ç‡ï¼Œè¦†ç›–ä¸‹ç­å‰åŠå°æ—¶è‡³1å°æ—¶çš„æ—¶é—´çª—å£
    - cron: '*/15 1-2,9-10,18-19 * * *'  # å¢åŠ æ‰§è¡Œé¢‘ç‡ï¼Œè¦†ç›–ä¸‹ç­å‰åŠå°æ—¶è‡³1å°æ—¶
  workflow_dispatch:
    inputs:
      test_time:
        description: 'æµ‹è¯•æ—¶é—´ (HH:MM)'
        required: false
        default: ''

jobs:
  daily-study-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: æ¯æ—¥ä¸€å­¦æé†’
        env:
          DINGTALK_TOKEN: c965583b00a0f7184e546e662b6902b0fdfab31b110d56249a45c7921e28defc
        run: |
          # è®¾ç½®æ—¶åŒº
          export TZ='Asia/Shanghai'
          
          # å¤„ç†æ‰‹åŠ¨è¾“å…¥çš„æµ‹è¯•æ—¶é—´
          if [ -n "${{ github.event.inputs.test_time }}" ]; then
            TEST_TIME="${{ github.event.inputs.test_time }}"
            echo "ä½¿ç”¨æµ‹è¯•æ—¶é—´: $TEST_TIME"
            CURRENT_HOUR=$(echo $TEST_TIME | cut -d: -f1)
            CURRENT_MINUTE=$(echo $TEST_TIME | cut -d: -f2)
            CURRENT_TIME=$TEST_TIME
          else
            CURRENT_HOUR=$(date +%H)
            CURRENT_MINUTE=$(date +%M)
            CURRENT_TIME=$(date +%H:%M)
          fi
          
          CURRENT_DATE=$(date +%Y-%m-%d)
          CURRENT_WEEK=$(date +%u)
          echo "å½“å‰æ—¶é—´(åŒ—äº¬æ—¶é—´): $(date)"
          echo "å½“å‰æ—¥æœŸ: $CURRENT_DATE"
          echo "å½“å‰æ—¶åˆ†: $CURRENT_TIME"
          
          # å¤„ç†è·¨å¤©ç­æ¬¡é—®é¢˜
          # å¦‚æœå½“å‰æ—¶é—´æ˜¯00:00-03:00ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥å‰ä¸€å¤©æ˜¯å¦æ˜¯ç”²ç­
          HOUR_NUM=$((10#$CURRENT_HOUR))
          ADJUSTED_DATE="$CURRENT_DATE"
          
          if [ $HOUR_NUM -lt 3 ] || [ $HOUR_NUM -ge 20 ]; then
            # åœ¨ç”²ç­å¯èƒ½çš„å·¥ä½œæ—¶é—´æ®µå†…ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥å‰ä¸€å¤©æ˜¯å¦æ˜¯ç”²ç­
            # è®¡ç®—å‰ä¸€å¤©çš„æ—¥æœŸ
            ADJUSTED_DATE=$(date -d "yesterday" +%Y-%m-%d)
            echo "è°ƒæ•´æ—¥æœŸä¸ºå‰ä¸€å¤©: $ADJUSTED_DATE (å¤„ç†è·¨å¤©ç­æ¬¡)"
          fi
          
          # å››ç­ä¸‰å€’å¾ªç¯è®¡ç®—ï¼Œä½¿ç”¨è°ƒæ•´åçš„æ—¥æœŸ
          START_DATE="2025-10-27"  # ä»¥2025-10-27ä¸ºç”²ç­å¼€å§‹
          DAYS_DIFF=$(( ($(date -d "$ADJUSTED_DATE" +%s) - $(date -d "$START_DATE" +%s)) / 86400 ))
          CYCLE_POS=$((DAYS_DIFF % 4))
          
          echo "ä»èµ·å§‹æ—¥ç›¸å·®å¤©æ•°: $DAYS_DIFF"
          echo "å‘¨æœŸä½ç½®: $CYCLE_POS (0=ç”²ç­, 1=ä¼‘ç­, 2=ä¹™ç­, 3=ä¸™ç­)"
          
          # åˆ¤æ–­ä»Šæ—¥ç­æ¬¡
          case $CYCLE_POS in
            0)
              TODAY_SHIFT="ç”²ç­ 20:00-03:00"
              SHIFT_END_HOUR=3
              IS_WORKING=true
              ;;
            1)
              TODAY_SHIFT="ä¼‘ç­"
              IS_WORKING=false
              ;;
            2)
              TODAY_SHIFT="ä¹™ç­ 03:00-11:00"
              SHIFT_END_HOUR=11
              IS_WORKING=true
              ;;
            3)
              TODAY_SHIFT="ä¸™ç­ 11:00-20:00"
              SHIFT_END_HOUR=20
              IS_WORKING=true
              ;;
          esac
          
          echo "ä»Šæ—¥ç­æ¬¡: $TODAY_SHIFT"
          
          # æ£€æŸ¥æ˜¯å¦åœ¨ä¸Šç­
          if [ "$IS_WORKING" = true ]; then
            # è®¡ç®—ä¸‹ç­å‰1å°æ—¶å’ŒåŠå°æ—¶çš„æ—¶é—´
            REMINDER_HOUR_START=$((SHIFT_END_HOUR - 1))
            REMINDER_HOUR_END=$((SHIFT_END_HOUR - 0))
            
            # å¤„ç†è·¨å¤©æƒ…å†µ
            if [ $REMINDER_HOUR_START -lt 0 ]; then
              REMINDER_HOUR_START=$((24 + REMINDER_HOUR_START))
            fi
            if [ $REMINDER_HOUR_END -lt 0 ]; then
              REMINDER_HOUR_END=$((24 + REMINDER_HOUR_END))
            fi
            
            echo "ä¸‹ç­æ—¶é—´: $SHIFT_END_HOUR:00"
            echo "æé†’æ—¶é—´èŒƒå›´: $REMINDER_HOUR_START:00 - $REMINDER_HOUR_END:30 (ä¸‹ç­å‰1å°æ—¶è‡³åŠå°æ—¶)"
            echo "å½“å‰æ—¶é—´: $CURRENT_HOUR:$CURRENT_MINUTE"
            
            # æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨æé†’æ—¶é—´èŒƒå›´å†…ï¼ˆä¸‹ç­å‰1å°æ—¶è‡³åŠå°æ—¶ï¼‰
            # è½¬æ¢ä¸ºåˆ†é’Ÿè¿›è¡Œæ¯”è¾ƒ
            current_total_minutes=$((10#$CURRENT_HOUR * 60 + 10#$CURRENT_MINUTE))
            reminder_start_minutes=$((REMINDER_HOUR_START * 60))
            reminder_end_minutes=$((REMINDER_HOUR_END * 60 + 30))
            
            # å¤„ç†è·¨å¤©æƒ…å†µ
            if [ $reminder_start_minutes -gt $reminder_end_minutes ]; then
              # å¦‚æœå¼€å§‹æ—¶é—´å¤§äºç»“æŸæ—¶é—´ï¼Œè¯´æ˜è·¨å¤©äº†
              if [ $current_total_minutes -ge $reminder_start_minutes ] || [ $current_total_minutes -le $reminder_end_minutes ]; then
                IN_REMINDER_WINDOW=true
              else
                IN_REMINDER_WINDOW=false
              fi
            else
              # æ­£å¸¸æƒ…å†µï¼Œæ²¡æœ‰è·¨å¤©
              if [ $current_total_minutes -ge $reminder_start_minutes ] && [ $current_total_minutes -le $reminder_end_minutes ]; then
                IN_REMINDER_WINDOW=true
              else
                IN_REMINDER_WINDOW=false
              fi
            fi
            
            if [ "$IN_REMINDER_WINDOW" = true ]; then
              echo "âœ… åœ¨æé†’æ—¶é—´çª—å£å†…ï¼Œå‘é€æ¯æ—¥ä¸€å­¦æé†’"
              
              # æ·»åŠ æ˜ŸæœŸä¿¡æ¯
              WEEK_DAYS=("å‘¨ä¸€" "å‘¨äºŒ" "å‘¨ä¸‰" "å‘¨å››" "å‘¨äº”" "å‘¨å…­" "å‘¨æ—¥")
              WEEK_INDEX=$((CURRENT_WEEK - 1))
              WEEK_INFO="${WEEK_DAYS[$WEEK_INDEX]}"
              
              # è®¡ç®—è·ç¦»ä¸‹ç­è¿˜æœ‰å¤šå°‘åˆ†é’Ÿ
              if [ $SHIFT_END_HOUR -lt $HOUR_NUM ]; then
                # è·¨å¤©æƒ…å†µ
                minutes_until_end=$(( (24 - HOUR_NUM + SHIFT_END_HOUR) * 60 - CURRENT_MINUTE ))
              else
                minutes_until_end=$(( (SHIFT_END_HOUR - HOUR_NUM) * 60 - CURRENT_MINUTE ))
              fi
              
              # æ„å»ºæé†’å†…å®¹
              CONTENT="ğŸ“š æ¯æ—¥ä¸€å­¦æé†’\n\nè¯·åŠæ—¶å°†ä»Šæ—¥å­¦ä¹ å†…å®¹å‘é€è‡³ç­é•¿é’‰é’‰\nâ° æé†’æ—¶é—´ï¼š$CURRENT_TIME\nğŸ“… $CURRENT_DATE $WEEK_INFO\nğŸ‘¨â€ğŸ’¼ ä»Šæ—¥ç­æ¬¡ï¼š$TODAY_SHIFT\nâ±ï¸ è·ç¦»ä¸‹ç­ï¼šçº¦${minutes_until_end}åˆ†é’Ÿ\n\nâš ï¸ æ³¨æ„äº‹é¡¹ï¼š\n- ä¸‹ç­å‰30åˆ†é’Ÿæœªå‘é€ï¼Œä¸å†æ¥æ”¶\n- è¯·åŠæ—¶åœ¨çº¿ç¼–è¾‘å¹¶æäº¤\n- ç¡®ä¿å†…å®¹å‡†ç¡®å®Œæ•´"
              
              # å‘é€é’‰é’‰æé†’
              curl -X POST -H "Content-Type: application/json" \
                -d "{
                  \"msgtype\": \"text\",
                  \"text\": {
                    \"content\": \"$CONTENT\"
                  },
                  \"at\": {
                    \"isAtAll\": false
                  }
                }" \
                "https://oapi.dingtalk.com/robot/send?access_token=$DINGTALK_TOKEN"
              
              echo "âœ… æ¯æ—¥ä¸€å­¦æé†’å·²å‘é€"
            else
              echo "â° ä¸åœ¨æé†’æ—¶é—´çª—å£å†…"
            fi
          else
            echo "âŒ ä»Šæ—¥ä¼‘ç­ï¼Œä¸å‘é€æ¯æ—¥ä¸€å­¦æé†’"
          fi
