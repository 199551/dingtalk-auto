name: 每日一学提醒
on:
  schedule:
    # 每15分钟执行一次，用于检查是否在提醒时间窗口内
    - cron: '*/15 1-2,9-10,18-19 * * *'  # 增加执行频率，覆盖下班前半小时至1小时
  workflow_dispatch:
    inputs:
      test_time:
        description: '测试时间 (HH:MM)'
        required: false
        default: ''

jobs:
  daily-study-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: 每日一学提醒
        env:
          DINGTALK_TOKEN: c965583b00a0f7184e546e662b6902b0fdfab31b110d56249a45c7921e28defc
        run: |
          # 设置时区
          export TZ='Asia/Shanghai'
          
          # 处理手动输入的测试时间
          if [ -n "${{ github.event.inputs.test_time }}" ]; then
            TEST_TIME="${{ github.event.inputs.test_time }}"
            echo "使用测试时间: $TEST_TIME"
            CURRENT_HOUR=$(echo $TEST_TIME | cut -d: -f1)
            CURRENT_MINUTE=$(echo $TEST_TIME | cut -d: -f2)
            CURRENT_TIME=$TEST_TIME
          else
            CURRENT_HOUR=$(date +%H)
            CURRENT_MINUTE=$(date +%M)
            CURRENT_TIME=$(date +%H:%M)
          fi
          
          CURRENT_DATE=$(date +%Y-%m-%d)
          CURRENT_WEEK=$(date +%u)
          echo "当前时间(北京时间): $(date)"
          echo "当前日期: $CURRENT_DATE"
          echo "当前时分: $CURRENT_TIME"
          
          # 处理跨天班次问题
          # 如果当前时间是00:00-03:00，我们需要检查前一天是否是甲班
          HOUR_NUM=$((10#$CURRENT_HOUR))
          ADJUSTED_DATE="$CURRENT_DATE"
          
          if [ $HOUR_NUM -lt 3 ] || [ $HOUR_NUM -ge 20 ]; then
            # 在甲班可能的工作时间段内，我们需要检查前一天是否是甲班
            # 计算前一天的日期
            ADJUSTED_DATE=$(date -d "yesterday" +%Y-%m-%d)
            echo "调整日期为前一天: $ADJUSTED_DATE (处理跨天班次)"
          fi
          
          # 四班三倒循环计算，使用调整后的日期
          START_DATE="2025-10-27"  # 以2025-10-27为甲班开始
          DAYS_DIFF=$(( ($(date -d "$ADJUSTED_DATE" +%s) - $(date -d "$START_DATE" +%s)) / 86400 ))
          CYCLE_POS=$((DAYS_DIFF % 4))
          
          echo "从起始日相差天数: $DAYS_DIFF"
          echo "周期位置: $CYCLE_POS (0=甲班, 1=休班, 2=乙班, 3=丙班)"
          
          # 判断今日班次
          case $CYCLE_POS in
            0)
              TODAY_SHIFT="甲班 20:00-03:00"
              SHIFT_END_HOUR=3
              IS_WORKING=true
              ;;
            1)
              TODAY_SHIFT="休班"
              IS_WORKING=false
              ;;
            2)
              TODAY_SHIFT="乙班 03:00-11:00"
              SHIFT_END_HOUR=11
              IS_WORKING=true
              ;;
            3)
              TODAY_SHIFT="丙班 11:00-20:00"
              SHIFT_END_HOUR=20
              IS_WORKING=true
              ;;
          esac
          
          echo "今日班次: $TODAY_SHIFT"
          
          # 检查是否在上班
          if [ "$IS_WORKING" = true ]; then
            # 计算下班前1小时和半小时的时间
            REMINDER_HOUR_START=$((SHIFT_END_HOUR - 1))
            REMINDER_HOUR_END=$((SHIFT_END_HOUR - 0))
            
            # 处理跨天情况
            if [ $REMINDER_HOUR_START -lt 0 ]; then
              REMINDER_HOUR_START=$((24 + REMINDER_HOUR_START))
            fi
            if [ $REMINDER_HOUR_END -lt 0 ]; then
              REMINDER_HOUR_END=$((24 + REMINDER_HOUR_END))
            fi
            
            echo "下班时间: $SHIFT_END_HOUR:00"
            echo "提醒时间范围: $REMINDER_HOUR_START:00 - $REMINDER_HOUR_END:30 (下班前1小时至半小时)"
            echo "当前时间: $CURRENT_HOUR:$CURRENT_MINUTE"
            
            # 检查当前是否在提醒时间范围内（下班前1小时至半小时）
            # 转换为分钟进行比较
            current_total_minutes=$((10#$CURRENT_HOUR * 60 + 10#$CURRENT_MINUTE))
            reminder_start_minutes=$((REMINDER_HOUR_START * 60))
            reminder_end_minutes=$((REMINDER_HOUR_END * 60 + 30))
            
            # 处理跨天情况
            if [ $reminder_start_minutes -gt $reminder_end_minutes ]; then
              # 如果开始时间大于结束时间，说明跨天了
              if [ $current_total_minutes -ge $reminder_start_minutes ] || [ $current_total_minutes -le $reminder_end_minutes ]; then
                IN_REMINDER_WINDOW=true
              else
                IN_REMINDER_WINDOW=false
              fi
            else
              # 正常情况，没有跨天
              if [ $current_total_minutes -ge $reminder_start_minutes ] && [ $current_total_minutes -le $reminder_end_minutes ]; then
                IN_REMINDER_WINDOW=true
              else
                IN_REMINDER_WINDOW=false
              fi
            fi
            
            # 创建一个标记文件路径，用于记录今天是否已经发送过提醒
            MARKER_FILE="/tmp/daily_study_reminder_${CURRENT_DATE}.marker"
            
            if [ "$IN_REMINDER_WINDOW" = true ]; then
              # 检查是否今天已经发送过提醒
              if [ -f "$MARKER_FILE" ]; then
                echo "⏰ 今天已经发送过每日一学提醒，跳过重复提醒"
              else
                echo "✅ 在提醒时间窗口内，发送每日一学提醒"
                
                # 添加星期信息
                WEEK_DAYS=("周一" "周二" "周三" "周四" "周五" "周六" "周日")
                WEEK_INDEX=$((CURRENT_WEEK - 1))
                WEEK_INFO="${WEEK_DAYS[$WEEK_INDEX]}"
                
                # 计算距离下班还有多少分钟
                if [ $SHIFT_END_HOUR -lt $HOUR_NUM ]; then
                  # 跨天情况
                  minutes_until_end=$(( (24 - HOUR_NUM + SHIFT_END_HOUR) * 60 - CURRENT_MINUTE ))
                else
                  minutes_until_end=$(( (SHIFT_END_HOUR - HOUR_NUM) * 60 - CURRENT_MINUTE ))
                fi
                
                # 构建提醒内容
                CONTENT="📚 每日一学提醒\n\n请及时将今日学习内容发送至班长钉钉\n⏰ 提醒时间：$CURRENT_TIME\n📅 $CURRENT_DATE $WEEK_INFO\n👨‍💼 今日班次：$TODAY_SHIFT\n⏱️ 距离下班：约${minutes_until_end}分钟\n\n⚠️ 注意事项：\n- 下班前30分钟未发送，不再接收\n- 请及时在线编辑并提交\n- 确保内容准确完整"
                
                # 发送钉钉提醒
                curl -X POST -H "Content-Type: application/json" \
                  -d "{
                    \"msgtype\": \"text\",
                    \"text\": {
                      \"content\": \"$CONTENT\"
                    },
                    \"at\": {
                      \"isAtAll\": false
                    }
                  }" \
                  "https://oapi.dingtalk.com/robot/send?access_token=$DINGTALK_TOKEN"
                
                # 创建标记文件，表示今天已经发送过提醒
                touch "$MARKER_FILE"
                echo "✅ 每日一学提醒已发送，并创建标记文件防止重复提醒"
              fi
            else
              echo "⏰ 不在提醒时间窗口内"
              # 如果不在提醒时间窗口内，删除标记文件（如果存在）
              if [ -f "$MARKER_FILE" ]; then
                rm "$MARKER_FILE"
                echo "🗑️ 删除标记文件，准备下一次提醒"
              fi
            fi
          else
            echo "❌ 今日休班，不发送每日一学提醒"
          fi
