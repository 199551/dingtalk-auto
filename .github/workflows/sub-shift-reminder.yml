name: ä¸Šå‰¯ç­æé†’
on:
  schedule:
    - cron: '*/10 2-3 * * 5,0'   # æ˜ŸæœŸäº”å’Œæ˜ŸæœŸæ—¥çš„UTC 2-3ç‚¹ (åŒ—äº¬æ—¶é—´10-11ç‚¹)
  workflow_dispatch:
    inputs:
      test_date:
        description: 'æµ‹è¯•æ—¥æœŸ (YYYY-MM-DD)'
        required: false
        default: ''

jobs:
  send-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        id: setup
        run: |
          # è®¾ç½®æ—¶åŒº
          export TZ='Asia/Shanghai'
          
          # å¤„ç†æ‰‹åŠ¨è¾“å…¥çš„æµ‹è¯•æ—¥æœŸ
          if [ -n "${{ github.event.inputs.test_date }}" ]; then
            TEST_DATE="${{ github.event.inputs.test_date }}"
            echo "ä½¿ç”¨æµ‹è¯•æ—¥æœŸ: $TEST_DATE"
            CURRENT_DATE=$TEST_DATE
          else
            CURRENT_DATE=$(date +%Y-%m-%d)
          fi
          
          # ä¿®å¤ï¼šæ›´ç²¾ç¡®çš„è·¨å¤©æ—¥æœŸè°ƒæ•´
          CURRENT_HOUR=$(date +%H)
          CURRENT_MINUTE=$(date +%M)
          HOUR_NUM=$((10#$CURRENT_HOUR))
          ADJUSTED_DATE="$CURRENT_DATE"
          
          # åªåœ¨çœŸæ­£è·¨å¤©çš„æ—¶é—´æ®µï¼ˆ00:00-02:59ï¼‰è°ƒæ•´æ—¥æœŸ
          if [ $HOUR_NUM -lt 3 ]; then
            # 00:00-02:59 å±äºå‰ä¸€å¤©çš„ç”²ç­
            ADJUSTED_DATE=$(date -d "yesterday" +%Y-%m-%d)
            echo "è°ƒæ•´æ—¥æœŸä¸ºå‰ä¸€å¤©: $ADJUSTED_DATE (å¤„ç†è·¨å¤©ç”²ç­)"
          else
            # 03:00-23:59 ä½¿ç”¨å½“å‰æ—¥æœŸ
            echo "ä½¿ç”¨å½“å‰æ—¥æœŸ: $ADJUSTED_DATE"
          fi
          
          # å››ç­ä¸‰å€’å¾ªç¯è®¡ç®—ï¼Œä½¿ç”¨è°ƒæ•´åçš„æ—¥æœŸ
          START_DATE="2025-10-27"  # ä»¥2025-10-27ä¸ºç”²ç­å¼€å§‹
          DAYS_DIFF=$(( ($(date -d "$ADJUSTED_DATE" +%s) - $(date -d "$START_DATE" +%s)) / 86400 ))
          CYCLE_POS=$((DAYS_DIFF % 4))
          
          echo "ä»èµ·å§‹æ—¥($START_DATE)ç›¸å·®å¤©æ•°: $DAYS_DIFF"
          echo "å‘¨æœŸä½ç½®: $CYCLE_POS (0=ç”²ç­, 1=ä¼‘ç­, 2=ä¹™ç­, 3=ä¸™ç­)"
          
          # åˆ¤æ–­ä»Šæ—¥ç­æ¬¡
          case $CYCLE_POS in
            0)
              TODAY_SHIFT="ç”²ç­ 20:00-03:00"
              IS_WORKING=true
              ;;
            1)
              TODAY_SHIFT="ä¼‘ç­"
              IS_WORKING=false
              ;;
            2)
              TODAY_SHIFT="ä¹™ç­ 03:00-11:00"
              IS_WORKING=true
              ;;
            3)
              TODAY_SHIFT="ä¸™ç­ 11:00-20:00"
              IS_WORKING=true
              ;;
          esac
          
          echo "ä»Šæ—¥ç­æ¬¡: $TODAY_SHIFT"
          
          # è·å–å½“å‰æ˜ŸæœŸå‡ 
          CURRENT_WEEK=$(date -d "$CURRENT_DATE" +%u)
          CURRENT_DAY_NAME=$(date -d "$CURRENT_DATE" +%A)
          echo "å½“å‰æ—¥æœŸ: $CURRENT_DATE"
          echo "å½“å‰æ˜ŸæœŸ: $CURRENT_WEEK ($CURRENT_DAY_NAME)"
          
          # è®¡ç®—æ˜å¤©æ˜¯æ˜ŸæœŸå‡ å’Œç­æ¬¡
          TOMORROW_DATE=$(date -d "$CURRENT_DATE +1 day" +%Y-%m-%d)
          TOMORROW_WEEK=$(date -d "$TOMORROW_DATE" +%u)
          TOMORROW_DAY_NAME=$(date -d "$TOMORROW_DATE" +%A)
          
          # è®¡ç®—æ˜å¤©çš„ç­æ¬¡ (å‘¨æœŸä½ç½®åŠ 1)
          TOMORROW_CYCLE_POS=$(( (CYCLE_POS + 1) % 4 ))
          case $TOMORROW_CYCLE_POS in
            0)
              TOMORROW_SHIFT="ç”²ç­ 20:00-03:00"
              ;;
            1)
              TOMORROW_SHIFT="ä¼‘ç­"
              ;;
            2)
              TOMORROW_SHIFT="ä¹™ç­ 03:00-11:00"
              ;;
            3)
              TOMORROW_SHIFT="ä¸™ç­ 11:00-20:00"
              ;;
          esac
          
          echo "æ˜å¤©æ—¥æœŸ: $TOMORROW_DATE"
          echo "æ˜å¤©æ˜ŸæœŸ: $TOMORROW_WEEK ($TOMORROW_DAY_NAME)"
          echo "æ˜å¤©ç­æ¬¡: $TOMORROW_SHIFT"
          
          # æ£€æŸ¥æ˜å¤©æ˜¯å¦éœ€è¦ä¸Šå‰¯ç­ï¼ˆæ˜å¤©æ˜¯ä¸™ç­ä¸”æ˜¯æ˜ŸæœŸå…­æˆ–æ˜ŸæœŸä¸€ï¼‰
          TOMORROW_NEEDS_SUB_SHIFT=false
          if [ $TOMORROW_CYCLE_POS -eq 3 ] && ([ $TOMORROW_WEEK -eq 6 ] || [ $TOMORROW_WEEK -eq 1 ]); then
            TOMORROW_NEEDS_SUB_SHIFT=true
            echo "æ˜å¤©éœ€è¦ä¸Šå‰¯ç­ï¼ˆä¸™ç­ä¸”æ˜¯æ˜ŸæœŸå…­æˆ–æ˜ŸæœŸä¸€ï¼‰"
          else
            echo "æ˜å¤©ä¸éœ€è¦ä¸Šå‰¯ç­"
          fi
          
          # æ£€æŸ¥æ˜¯å¦åœ¨æé†’æ—¶é—´çª—å£å†… (10:00å‰å1å°æ—¶)
          SHOULD_REMIND=false
          TARGET_HOUR="10"
          TARGET_MINUTE="00"
          
          current_total_minutes=$((10#$CURRENT_HOUR * 60 + 10#$CURRENT_MINUTE))
          target_total_minutes=$((10#$TARGET_HOUR * 60 + 10#$TARGET_MINUTE))
          time_diff=$((current_total_minutes - target_total_minutes))
          
          # å‰å60åˆ†é’Ÿçª—å£
          if [ $time_diff -ge -60 ] && [ $time_diff -le 60 ]; then
            SHOULD_REMIND=true
            
            if [ $time_diff -lt 0 ]; then
              TIME_DIRECTION="å‰"
              MINUTES_AWAY=$((0 - $time_diff))
            elif [ $time_diff -gt 0 ]; then
              TIME_DIRECTION="å" 
              MINUTES_AWAY=$time_diff
            else
              TIME_DIRECTION="æ­£å¥½"
              MINUTES_AWAY=0
            fi
          fi
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "tomorrow_needs_sub_shift=$TOMORROW_NEEDS_SUB_SHIFT" >> $GITHUB_OUTPUT
          echo "should_remind=$SHOULD_REMIND" >> $GITHUB_OUTPUT
          echo "time_direction=$TIME_DIRECTION" >> $GITHUB_OUTPUT
          echo "minutes_away=$MINUTES_AWAY" >> $GITHUB_OUTPUT
          echo "tomorrow_date=$TOMORROW_DATE" >> $GITHUB_OUTPUT
          echo "tomorrow_week=$TOMORROW_WEEK" >> $GITHUB_OUTPUT
          echo "tomorrow_shift=$TOMORROW_SHIFT" >> $GITHUB_OUTPUT
          echo "today_shift=$TODAY_SHIFT" >> $GITHUB_OUTPUT

      - name: å‘é€æé†’
        if: steps.setup.outputs.tomorrow_needs_sub_shift == 'true' && steps.setup.outputs.should_remind == 'true'
        env:
          DINGTALK_TOKEN: ${{ secrets.DINGTALK_TOKEN }}
        run: |
          echo "â° åœ¨æé†’æ—¶é—´çª—å£å†…: 10:00 (${{ steps.setup.outputs.time_direction }}${{ steps.setup.outputs.minutes_away }}åˆ†é’Ÿ)"
          echo "ğŸ“… æ£€æµ‹åˆ°æ˜å¤©éœ€è¦ä¸Šå‰¯ç­ï¼Œå‘é€æé†’"
          
          if [ ${{ steps.setup.outputs.tomorrow_week }} -eq 6 ]; then
            DAY_NAME="æ˜ŸæœŸå…­"
          else
            DAY_NAME="æ˜ŸæœŸä¸€"
          fi
          
          # æ„å»ºå®Œæ•´å†…å®¹
          MESSAGE="ğŸ“¢ ä¸Šå‰¯ç­æé†’\n\næ˜å¤©ï¼ˆ$DAY_NAMEï¼‰éœ€è¦ä¸Šå‰¯ç­\nâ° å·¥ä½œæ—¶é—´ï¼š11:00-20:00\nğŸ“… æ—¥æœŸï¼š${{ steps.setup.outputs.tomorrow_date }}\nğŸ‘¨â€ğŸ’¼ ä»Šæ—¥ç­æ¬¡ï¼š${{ steps.setup.outputs.today_shift }}\nğŸ‘¨â€ğŸ’¼ æ˜æ—¥ç­æ¬¡ï¼š${{ steps.setup.outputs.tomorrow_shift }}\nğŸ¯ è¯·æå‰åšå¥½å‡†å¤‡ï¼\n\nâ±ï¸ æé†’æ—¶é—´ï¼š$(date +%Y-%m-%d\ %H:%M)"
          
          # å‘é€é’‰é’‰æé†’
          curl -X POST -H "Content-Type: application/json" \
            -d "{
              \"msgtype\": \"text\",
              \"text\": {
                \"content\": \"$MESSAGE\"
              }
            }" \
            "https://oapi.dingtalk.com/robot/send?access_token=$DINGTALK_TOKEN"
          
          echo "âœ… å‰¯ç­æé†’å·²å‘é€"
