name: å‰¯ç­æé†’æœåŠ¡
on:
  schedule:
    # åœ¨å‘¨äº”å’Œå‘¨æ—¥çš„å‰ä¸€ä¸ªç­æ¬¡ä¸‹ç­å‰æ—¶é—´æ®µæ‰§è¡Œï¼ˆæé†’æ˜æ—¥ä¸Šå‰¯ç­ï¼‰
    - cron: '0,15,30,45 1-2,9-10 * * 5,0'  # UTCæ—¶é—´è¦†ç›–å‘¨äº”å’Œå‘¨æ—¥çš„å‰ä¸€ä¸ªç­æ¬¡ä¸‹ç­å‰
  workflow_dispatch:
    inputs:
      description:
        description: 'æ‰‹åŠ¨è§¦å‘å‰¯ç­æé†’æµ‹è¯•'
        required: false
        default: 'æµ‹è¯•æ‰§è¡Œ'

jobs:
  send-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: å‰¯ç­æé†’
        env:
          DINGTALK_TOKEN: c965583b00a0f7184e546e662b6902b0fdfab31b110d56249a45c7921e28defc
        run: |
          # è®¾ç½®æ—¶åŒº
          export TZ='Asia/Shanghai'
          
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œæ˜¾ç¤ºæµ‹è¯•ä¿¡æ¯
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸš€ æ‰‹åŠ¨è§¦å‘å‰¯ç­æé†’æµ‹è¯•"
            echo "è¾“å…¥æè¿°: ${{ github.event.inputs.description }}"
          fi
          
          # è·å–å½“å‰æ—¶é—´
          CURRENT_WEEKDAY=$(date +%u)  # 1=å‘¨ä¸€, 5=å‘¨äº”, 7=å‘¨æ—¥
          CURRENT_HOUR=$(date +%H)
          CURRENT_MINUTE=$(date +%M)
          CURRENT_DATE=$(date +%Y-%m-%d)
          CURRENT_TIME=$(date +%H:%M)
          
          echo "å½“å‰æ—¥æœŸ: $CURRENT_DATE"
          echo "å½“å‰æ˜ŸæœŸ: $CURRENT_WEEKDAY"
          echo "å½“å‰æ—¶é—´: $CURRENT_TIME"
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯å‘¨äº”æˆ–å‘¨æ—¥ï¼ˆæé†’æ˜æ—¥ä¸Šå‰¯ç­ï¼‰
          if [ "$CURRENT_WEEKDAY" != "5" ] && [ "$CURRENT_WEEKDAY" != "0" ]; then
            echo "âŒ ä»Šå¤©ä¸æ˜¯å‘¨äº”æˆ–å‘¨æ—¥ï¼Œä¸å‘é€å‰¯ç­æé†’"
            # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œå³ä½¿ä¸æ˜¯å‘¨äº”æˆ–å‘¨æ—¥ä¹Ÿç»§ç»­æ‰§è¡Œ
            if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
              exit 0
            fi
          fi
          
          # å››ç­ä¸‰å€’å¾ªç¯è®¡ç®—
          START_DATE="2025-10-27"  # ä»¥2025-10-27ä¸ºç”²ç­å¼€å§‹
          DAYS_DIFF=$(( ($(date -d "$CURRENT_DATE" +%s) - $(date -d "$START_DATE" +%s)) / 86400 ))
          CYCLE_POS=$((DAYS_DIFF % 4))
          
          echo "ä»èµ·å§‹æ—¥ç›¸å·®å¤©æ•°: $DAYS_DIFF"
          echo "å‘¨æœŸä½ç½®: $CYCLE_POS (0=ç”²ç­, 1=ä¼‘ç­, 2=ä¹™ç­, 3=ä¸™ç­)"
          
          # åˆ¤æ–­ä»Šæ—¥ç­æ¬¡
          case $CYCLE_POS in
            0)
              TODAY_SHIFT="ç”²ç­ 20:00-03:00"
              SHIFT_END_HOUR=3
              ;;
            1)
              TODAY_SHIFT="ä¼‘ç­"
              SHIFT_END_HOUR=0
              ;;
            2)
              TODAY_SHIFT="ä¹™ç­ 03:00-11:00"
              SHIFT_END_HOUR=11
              ;;
            3)
              TODAY_SHIFT="ä¸™ç­ 11:00-20:00"
              SHIFT_END_HOUR=20
              ;;
          esac
          
          echo "ä»Šæ—¥ç­æ¬¡: $TODAY_SHIFT"
          
          # è®¡ç®—ä¸‹ç­å‰1å°æ—¶å’ŒåŠå°æ—¶çš„æ—¶é—´çª—å£
          REMINDER_HOUR_START=$((SHIFT_END_HOUR - 1))
          REMINDER_HOUR_END=$((SHIFT_END_HOUR - 0))
          
          # å¤„ç†è·¨å¤©æƒ…å†µ
          if [ $REMINDER_HOUR_START -lt 0 ]; then
            REMINDER_HOUR_START=$((24 + REMINDER_HOUR_START))
          fi
          if [ $REMINDER_HOUR_END -lt 0 ]; then
            REMINDER_HOUR_END=$((24 + REMIND_END_HOUR))
          fi
          
          echo "ä¸‹ç­æ—¶é—´: $SHIFT_END_HOUR:00"
          echo "æé†’æ—¶é—´èŒƒå›´: $REMINDER_HOUR_START:00 - $REMINDER_HOUR_END:30 (ä¸‹ç­å‰1å°æ—¶è‡³åŠå°æ—¶)"
          
          # æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨æé†’æ—¶é—´èŒƒå›´å†…ï¼ˆä¸‹ç­å‰1å°æ—¶è‡³åŠå°æ—¶ï¼‰
          current_total_minutes=$((10#$CURRENT_HOUR * 60 + 10#$CURRENT_MINUTE))
          reminder_start_minutes=$((REMINDER_HOUR_START * 60))
          reminder_end_minutes=$((REMINDER_HOUR_END * 60 + 30))
          
          # å¤„ç†è·¨å¤©æƒ…å†µ
          if [ $reminder_start_minutes -gt $reminder_end_minutes ]; then
            # å¦‚æœå¼€å§‹æ—¶é—´å¤§äºç»“æŸæ—¶é—´ï¼Œè¯´æ˜è·¨å¤©äº†
            if [ $current_total_minutes -ge $reminder_start_minutes ] || [ $current_total_minutes -le $reminder_end_minutes ]; then
              IN_REMINDER_WINDOW=true
            else
              IN_REMINDER_WINDOW=false
            fi
          else
            # æ­£å¸¸æƒ…å†µï¼Œæ²¡æœ‰è·¨å¤©
            if [ $current_total_minutes -ge $reminder_start_minutes ] && [ $current_total_minutes -le $reminder_end_minutes ]; then
              IN_REMINDER_WINDOW=true
            else
              IN_REMINDER_WINDOW=false
            fi
          fi
          
          # åˆ›å»ºæ ‡è®°æ–‡ä»¶è·¯å¾„ï¼Œç”¨äºè®°å½•ä»Šå¤©æ˜¯å¦å·²ç»å‘é€è¿‡æé†’
          MARKER_FILE="/tmp/assistant_shift_reminder_${CURRENT_DATE}.marker"
          
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘æˆ–ç¬¦åˆè‡ªåŠ¨è§¦å‘æ¡ä»¶
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "$IN_REMINDER_WINDOW" = true ]; then
            # æ£€æŸ¥æ˜¯å¦ä»Šå¤©å·²ç»å‘é€è¿‡æé†’
            if [ -f "$MARKER_FILE" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
              echo "â° ä»Šå¤©å·²ç»å‘é€è¿‡å‰¯ç­æé†’ï¼Œè·³è¿‡é‡å¤æé†’"
            else
              # ç¡®å®šæ˜æ—¥æ˜ŸæœŸå’Œæ—¥æœŸ
              TOMORROW_DATE=$(date -d "tomorrow" +%Y-%m-%d)
              TOMORROW_WEEKDAY=$(date -d "tomorrow" +%u)
              
              # æ„å»ºæé†’å†…å®¹
              CONTENT="ğŸ“¢ å‰¯ç­æé†’\n\næ˜æ—¥($TOMORROW_DATE)ä¸Šå‰¯ç­(11:00-20:00)\nè¯·æå‰åšå¥½å·¥ä½œå®‰æ’\nâ° æé†’æ—¶é—´ï¼š$CURRENT_TIME\nğŸ“… å½“å‰æ—¥æœŸï¼š$CURRENT_DATE\nğŸ‘¨â€ğŸ’¼ å½“å‰ç­æ¬¡ï¼š$TODAY_SHIFT\n\nğŸ’¡ æ¸©é¦¨æç¤ºï¼š\n- å‰¯ç­å·¥ä½œæ—¶é—´ï¼š11:00-20:00\n- è¯·åˆç†å®‰æ’ä½œæ¯æ—¶é—´\n- ç¡®ä¿å·¥ä½œäº¤æ¥é¡ºåˆ©å®Œæˆ"
              
              # å‘é€é’‰é’‰æé†’
              curl -X POST -H "Content-Type: application/json" \
                -d "{
                  \"msgtype\": \"text\",
                  \"text\": {
                    \"content\": \"$CONTENT\"
                  },
                  \"at\": {
                    \"isAtAll\": false
                  }
                }" \
                "https://oapi.dingtalk.com/robot/send?access_token=$DINGTALK_TOKEN"
              
              # åˆ›å»ºæ ‡è®°æ–‡ä»¶ï¼Œè¡¨ç¤ºä»Šå¤©å·²ç»å‘é€è¿‡æé†’
              touch "$MARKER_FILE"
              echo "âœ… å‰¯ç­æé†’å·²å‘é€ï¼Œå¹¶åˆ›å»ºæ ‡è®°æ–‡ä»¶é˜²æ­¢é‡å¤æé†’"
            fi
          else
            echo "â° ä¸åœ¨æé†’æ—¶é—´çª—å£å†…"
            # å¦‚æœä¸åœ¨æé†’æ—¶é—´çª—å£å†…ï¼Œåˆ é™¤æ ‡è®°æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -f "$MARKER_FILE" ]; then
              rm "$MARKER_FILE"
              echo "ğŸ—‘ï¸ åˆ é™¤æ ‡è®°æ–‡ä»¶ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡æé†’"
            fi
          fi
