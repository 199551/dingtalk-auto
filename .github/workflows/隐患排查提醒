name: éšæ‚£æ’æŸ¥æœˆåº¦æé†’
on:
  schedule:
    # æ¯æœˆ22æ—¥ä¸Šåˆ9:00æ‰§è¡Œ (UTC+8 åŒ—äº¬æ—¶é—´)
    - cron: '0 1 22 * *'  # æ¯æœˆ22å· UTC 1:00 = åŒ—äº¬æ—¶é—´9:00
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•
    inputs:
      test_month:
        description: 'æµ‹è¯•æœˆä»½ (YYYY-MM)'
        required: false
        default: ''

jobs:
  send-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: å‘é€éšæ‚£æ’æŸ¥æœˆåº¦æé†’
        env:
          DINGTALK_TOKEN: c965583b00a0f7184e546e662b6902b0fdfab31b110d56249a45c7921e28defc
        run: |
          # è®¾ç½®æ—¶åŒº
          export TZ='Asia/Shanghai'
          
          # å¤„ç†æ‰‹åŠ¨è¾“å…¥çš„æµ‹è¯•æœˆä»½
          if [ -n "${{ github.event.inputs.test_month }}" ]; then
            TEST_MONTH="${{ github.event.inputs.test_month }}"
            echo "ä½¿ç”¨æµ‹è¯•æœˆä»½: $TEST_MONTH"
            CURRENT_YEAR=$(echo $TEST_MONTH | cut -d'-' -f1)
            CURRENT_MONTH=$(echo $TEST_MONTH | cut -d'-' -f2)
          else
            CURRENT_YEAR=$(date +%Y)
            CURRENT_MONTH=$(date +%m)
          fi
          
          CURRENT_DATE=$(date +%Y-%m-%d)
          echo "æ‰§è¡Œæ—¶é—´: $(date)"
          echo "å½“å‰å¹´æœˆ: $CURRENT_YEAR-$CURRENT_MONTH"
          
          # æ„å»ºæé†’å†…å®¹
          MESSAGE="ğŸ” **éšæ‚£æ’æŸ¥æœˆåº¦æé†’**\n\nğŸ“… æœˆä»½ï¼š$CURRENT_YEARå¹´$CURRENT_MONTHæœˆ\nğŸ“ è¦æ±‚ï¼šæ¯æœˆæœ€å°‘å®Œæˆ1æ¡éšæ‚£æ’æŸ¥\nâ° æé†’æ—¶é—´ï¼š$CURRENT_DATE\nğŸ’¡ è¯·åŠæ—¶å®Œæˆå¹¶ä¸ŠæŠ¥éšæ‚£æ’æŸ¥è®°å½•"
          
          # å‘é€é’‰é’‰æé†’
          curl -X POST -H "Content-Type: application/json" \
            -d "{
              \"msgtype\": \"markdown\",
              \"markdown\": {
                \"title\": \"éšæ‚£æ’æŸ¥æœˆåº¦æé†’\",
                \"text\": \"$MESSAGE\"
              },
              \"at\": {
                \"isAtAll\": false
              }
            }" \
            "https://oapi.dingtalk.com/robot/send?access_token=$DINGTALK_TOKEN"
          
          echo "âœ… éšæ‚£æ’æŸ¥æœˆåº¦æé†’å·²å‘é€"
