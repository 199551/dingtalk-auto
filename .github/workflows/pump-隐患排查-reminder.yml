name: 隐患排查月度提醒
on:
  schedule:
    # 每月22日北京时间8:30、9:00、9:30各执行一次
    - cron: '30 0,1 22 * *'  # 每月22号 UTC 0:30,1:00,1:30 = 北京时间8:30,9:00,9:30
  workflow_dispatch:  # 允许手动触发测试
    inputs:
      test_month:
        description: '测试月份 (YYYY-MM)'
        required: false
        default: ''

jobs:
  send-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: 发送隐患排查月度提醒
        env:
          DINGTALK_TOKEN: c965583b00a0f7184e546e662b6902b0fdfab31b110d56249a45c7921e28defc
        run: |
          # 设置时区
          export TZ='Asia/Shanghai'
          
          # 处理手动输入的测试月份
          if [ -n "${{ github.event.inputs.test_month }}" ]; then
            TEST_MONTH="${{ github.event.inputs.test_month }}"
            echo "使用测试月份: $TEST_MONTH"
            CURRENT_YEAR=$(echo $TEST_MONTH | cut -d'-' -f1)
            CURRENT_MONTH=$(echo $TEST_MONTH | cut -d'-' -f2)
          else
            CURRENT_YEAR=$(date +%Y)
            CURRENT_MONTH=$(date +%m)
          fi
          
          CURRENT_DATE=$(date +%Y-%m-%d)
          CURRENT_DAY=$(date +%d)
          CURRENT_HOUR=$(date +%H)
          CURRENT_MINUTE=$(date +%M)
          CURRENT_TIME=$(date +%H:%M)
          
          echo "执行时间: $(date)"
          echo "当前年月: $CURRENT_YEAR-$CURRENT_MONTH"
          echo "当前时间: $CURRENT_TIME"
          
          # 判断今天是否是每月22日
          IS_22ND_DAY=false
          if [ "$CURRENT_DAY" = "22" ] || [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
            IS_22ND_DAY=true
            echo "✅ 今天是每月22日或手动触发"
          else
            echo "❌ 今天不是每月22日，跳过发送"
            exit 0
          fi
          
          # 检查是否在上午9:00前后半小时内 (8:30-9:30)
          IS_9AM_WINDOW=false
          CURRENT_TIME_NUM=$((10#$CURRENT_HOUR * 100 + 10#$CURRENT_MINUTE))
          
          if [ $CURRENT_TIME_NUM -ge 830 ] && [ $CURRENT_TIME_NUM -le 930 ]; then
            IS_9AM_WINDOW=true
            echo "✅ 当前在上午9:00前后半小时窗口内 (8:30-9:30)"
          else
            echo "❌ 当前不在上午9:00前后半小时窗口内"
          fi
          
          # 创建标记文件路径，用于记录今天是否已经发送过提醒
          MARKER_FILE="/tmp/hidden_danger_reminder_${CURRENT_DATE}.marker"
          
          # 发送提醒的条件：每月22日、在9:00时间窗口内、且今天还未发送过
          if [ "$IS_22ND_DAY" = true ] && [ "$IS_9AM_WINDOW" = true ]; then
            if [ -f "$MARKER_FILE" ]; then
              echo "⏰ 今天已经发送过隐患排查月度提醒，跳过重复提醒"
            else
              echo "✅ 满足所有发送条件，发送隐患排查月度提醒..."
              
              # 构建提醒内容
              MESSAGE="🔍 **隐患排查月度提醒**\n\n📅 月份：$CURRENT_YEAR年$CURRENT_MONTH月\n📝 要求：每月最少完成1条隐患排查\n⏰ 提醒时间：$CURRENT_DATE\n💡 请及时完成并上报隐患排查记录"
              
              # 发送钉钉提醒
              curl -X POST -H "Content-Type: application/json" \
                -d "{
                  \"msgtype\": \"markdown\",
                  \"markdown\": {
                    \"title\": \"隐患排查月度提醒\",
                    \"text\": \"$MESSAGE\"
                  },
                  \"at\": {
                    \"isAtAll\": false
                  }
                }" \
                "https://oapi.dingtalk.com/robot/send?access_token=$DINGTALK_TOKEN"
              
              # 创建标记文件，表示今天已经发送过提醒
              touch "$MARKER_FILE"
              echo "✅ 隐患排查月度提醒已发送，并创建标记文件防止重复提醒"
            fi
          else
            echo "❌ 不满足发送条件："
            if [ "$IS_22ND_DAY" != true ]; then
              echo "  - 今天不是每月22日"
            fi
            if [ "$IS_9AM_WINDOW" != true ]; then
              echo "  - 当前不在上午9:00前后半小时窗口内"
            fi
            
            # 如果不在发送条件内，但已经不是22日，删除标记文件
            if [ -f "$MARKER_FILE" ] && [ "$CURRENT_DAY" != "22" ]; then
              rm "$MARKER_FILE"
              echo "🗑️ 删除过期标记文件"
            fi
          fi
